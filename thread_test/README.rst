copied from samples/basic/threads